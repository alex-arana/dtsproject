#labels Phase-Implementation,Install-Guide,User-Guide
<wiki:toc max_depth="3" />

== Data Transfer Service ==

The Data Transfer Service is composed of a number of components and the sections below will show you how each of the DTS modules can be installed and used. 


=== Preinstall ===
==== Prerequisites ====
Following is a list of software components required to get the Data Transfer Service components running. Each item in the list contains a link to the product website where you can download the required distribution files:

   * [http://java.sun.com/javase/downloads/ Java SE JDK] Current release is [http://java.sun.com/javase/6/webnotes/6u14.html JDK 6 Update 18]
   * [http://subversion.tigris.org/getting.html Subversion]
   * [http://maven.apache.org/ Maven]
   * [http://activemq.apache.org/ ActiveMQ]
   * [http://www.mysql.com/ MySQL Database]
   * The database of your choice. We're using [http://www.mysql.com MySQL].

==== Getting The Code ====
The DTS codebase is currently hosted in the DTS Google Code SVN repository. You can check out the code by running:
{{{
  > cd /usr/local
  > svn checkout http://dtsproject.googlecode.com/svn/trunk/ minx-dts
}}}


=== Install ===
==== Build the project ====
{{{
 > cd minx-dts
 > touch /usr/local/minx-dts/dts-batchjob/src/test/filters/filter.properties
 > touch /usr/local/minx-dts/dts-ws/src/test/filters/filter.properties
 > touch /usr/local/minx-dts/dts-workernode/src/test/filters/filter.properties
 > touch /usr/local/minx-dts/dts-broker/src/test/filters/filter.properties
 > mvn -DskipTests=true install
}}}

=== Postinstall ===
==== DTS Batch Job ====

Run the following commands...
{{{
 > cd ~
 > mkdir .dataminx
 > cd .dataminx
 > cp /usr/local/minx-dts/dts-batchjob/src/main/resources/dts-bulkcopyjob.properties.template ~/.dataminx/dts-bulkcopyjob.properties
}}}

Edit the values of the following fields in dts-bulkcopyjob.properties
   * batch.jdbc.user
   * batch.jdbc.password

Create the Spring Batch DB by running the db script provided in /usr/local/minx-dts/dts-batchjob/src/main/resources/db for the DB you are using. Provide the user who will run the DTS access to it. Remember to use a password for root@localhost and dts-user@localhost if you've decided to use MySQL.

Run /usr/local/minx-dts/dts-batchjob/src/test/resources/create-testfiles.sh to create the test files the unit tests would use.

Add this line to /usr/local/minx-dts/dts-batchjob/src/test/filters/filter.properties and use the DTS user's home directory as its value
{{{
users.home.dir=<the DTS user's home directory>
}}}

Run the test
{{{
 > mvn -e -Ddataminx.dir=/home/dts-user/.dataminx test
 > mvn -e -Ddataminx.dir=/home/dts-user/.dataminx integration-test
}}}

*TODO: Write up the fix we've done to get around the problem with dataminx.dir not being picked up from the context xml files. dataminx.dir is needed so plugin-context.xml can be imported.*

Edit testjob.xml in src/test/resources/org/dataminx/dts/batch and add the source/destination you want to access then run the command below. Remember to add your credential details to filter.properties in src/test/filters if you don't want to put your credentials in the actual job document.
{{{
 > mvn -Ddataminx.dir=/home/dts-user/.dataminx -Dtest=QuickBulkCopyJobIntegrationTest test
}}}

==== DTS Workernode ====

Start ActiveMQ
{{{
 > $ACTIVEMQ_HOME/bin/activemq
}}}

Configure the dts-workernode
{{{
 > cd dts-workernode
 > cp src/main/resources/dts-workernode.properties.default ~/.dataminx/dts-workernode.properties
 > # edit ~/.dataminx/dts-workernode.properties if you need to. by default the values in the properties file should just work
 > # set value of wn.id to the name of the host running the dts-workernode module. This should be unique.
 > mvn -Ddataminx.dir=~/.dataminx exec:java
}}}

==== DTS Broker ====
You will need the following files in the dataminx.dir for running the DTS Broker:
   # dts-broker.properties
   # plugin-context.xml

The template files can be found in src/main/resources of the dts-broker module.

Assuming the ActiveMQ instance is still running from the configuration and deployment of the dts-workernode stage, run the following command to start Broker
{{{
 > mvn -Ddataminx.dir=/home/dts-user/.dataminx exec:java
}}}

To run a test against the broker simply type:
{{{
 > mvn test 
 > mvn integration-test
}}}

==== DTS WS ====

Edit src/test/filter/filter.properties and add the following lines
{{{
auth.username=test
auth.password=test
}}}

Add a file in ~/.dataminx directory called passwd and add this line
{{{
test:test
}}}

Setup the DB for DTS WS
{{{
 > cd dts-domain/src/main/resources/db
 > mysql -u root < create-accts.sql
 > mysql -u dts -D dts -p < create-tables.sql

Copy the other config files into the ~/.dataminx directory
{{{
cp dts-ws.properties.template to ~/.dataminx
cp log4j.xml to ~/.dataminx
}}}

==== Deploying the WS on Tomcat ====
   * Before you go ahead and follow the succeeding instructions, you might consider just running the DTS-WS as an embedded Jetty web application for test purposes. If you do, have a look at the "Running the DTS-WS as an embedded application inside Jetty" section on this page.
   * On Eclipse, from the servers view, add (with "Add Remove Projects") the dts-ws module (which is an Eclipse project now)
   * Run the server once, then stop it. Now go to run configurations of your tomcat server and add `-Djava.security.auth.login.config="/<thedirectory-on-where-your-jaas-config-is-located>/jaas.config" -Ddataminx.dir=/<your-dataminx-config-directory"` for me, on my development box, `jaas.config` is in `/home/gerson/Workspaces/dataminx-new/minx-dts/dts-security/src/main/resources/jaas.config.default` and `dataminx.dir` points to `/home/gerson.dataminx`. Now run it again.
   * An alternative to specifying the `java.security.auth.login.config` is to edit `/usr/lib/jvm/java-1.6.0-sun-1.6.0.11/jre/lib/security/java.security` and add `url.1` as `${user.home}/.java.login.config`. Please note you'll need to copy `jaas.config.default` in the dts-security module to `~/.java.login.config`
   * Check if you can see the WSDL by going to http://localhost:18080/dts-ws/dts.wsdl. If you are not getting any 404 error message, the DTS-WS deployment worked for you.
   * Note that jaas.config.default file uses a clear text password file for authentication. Before running a test job on the web service, you'll need to put a file, `passwd` into your `$HOME/.dataminx` directory. passwd should contain this line:
{{{
test:test
}}}
   * (Optional) If you have an X509 cert and also have an access to the ARCS MyProxy repository, you can try using the `jaas.config.myproxy`. You need to start up the Tomcat server using `jaas.config.myproxy` as the parameter to `java.security.auth.login.config` system property.

==== Testing the DTS-WS ====
This test will submit a job to the WS which will then pass on the work to the WN. It is important that you have the WN running before you try out this integration test. You can have a look on the DTSWorkerNodePrototype for more info on how to configure and get the DTS-WN module running.
{{{
   > cd dts-ws
   > mvn integration-test
}}}

==== Running the DTS-WS as an embedded application inside Jetty (Optional). ====
You can use try this option if you don't feel like configuring Tomcat from within Eclipse or you just want to quickly test the Data Transfer Service.
{{{
  > cd ~/Workspaces/dataminx/minx-dts/dts-ws
  > mvn -Djava.security.auth.login.config="/<path-to>/jaas.config.default" -Ddataminx.dir=/home/gerson/.dataminx exec:java
}}}

==== FAQ ====
   * I'm getting this exception (`com.sun.xml.internal.messaging.saaj.soap.LocalStrings != com.sun.xml.messaging.saaj.soap.LocalStrings`) if I run both the portal and ws on a single tomcat instance http://forums.java.net/jive/thread.jspa?threadID=41696 use a newer version of saaj (> 1.3.1) and put in tomcat's common/endorsed directory

edit jms.properties
change si.jms.jobSubmitQueueName=broker.job.submission.queue




use the jaas.config.default in starting it up