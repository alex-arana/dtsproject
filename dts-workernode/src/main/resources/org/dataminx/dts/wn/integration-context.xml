<beans:beans xmlns="http://www.springframework.org/schema/integration"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:beans="http://www.springframework.org/schema/beans"
    xmlns:jms="http://www.springframework.org/schema/integration/jms"
    xmlns:si-xml="http://www.springframework.org/schema/integration/xml"
    xmlns:util="http://www.springframework.org/schema/util"
    xsi:schemaLocation="http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
           http://www.springframework.org/schema/integration
           http://www.springframework.org/schema/integration/spring-integration-1.0.xsd
           http://www.springframework.org/schema/integration/xml
           http://www.springframework.org/schema/integration/xml/spring-integration-xml-1.0.xsd
           http://www.springframework.org/schema/integration/jms
           http://www.springframework.org/schema/integration/jms/spring-integration-jms-1.0.xsd
           http://www.springframework.org/schema/util
           http://www.springframework.org/schema/util/spring-util-2.0.xsd">

  <annotation-config/>

  <!-- Defines a point-to-point channel for receiving DTS job requests. -->
  <channel id="dtsJobRequests"/>
  <channel id="dtsJobEvents"/>
  <channel id="dtsJobExecutions"/>

 
  <beans:bean class="org.dataminx.dts.wn.jms.DtsSourcePollingChannelAdapter">
    <beans:property name="trigger" ref="trigger"/>
    <beans:property name="source" ref="jmsMessageSource"/>
    <beans:property name="outputChannel" ref="dtsJobRequests"/>
    <beans:property name="transactionManager" ref="jmsTransactionManager"/>
    <beans:property name="mWorkerNodeManager" ref="workerNodeManager"/>
  </beans:bean>
  
  <beans:bean id="jmsMessageSource" class="org.springframework.integration.jms.JmsDestinationPollingSource">
    <beans:constructor-arg index="0" ref="convertableJmsTemplate"/>
  </beans:bean>
  
  <beans:bean id="trigger" class="org.springframework.integration.scheduling.IntervalTrigger">
    <beans:constructor-arg value="10000"/>
  </beans:bean>

  <beans:bean id="workerNodeManager" class="org.dataminx.dts.wn.WorkerNodeManager">
  </beans:bean>
  
  <!--
    Defines an inbound JMS channel adapter for the DTS job submission queue.
    The inbound adapter means we are receiving from JMS and placing an instance of
    org.springframework.integration.core.Message on the configured channel.
  
  <jms:message-driven-channel-adapter
      channel="dtsJobRequests"
      connection-factory="jmsConnectionFactory"
      destination="jmsJobSubmitQueue"
      message-converter="dtsMessageConverter"
      transaction-manager="jmsTransactionManager"
      />
  -->
  <!--
    Defines an outbound JMS channel adapter for DTS job events and progress
    notifications.
  -->
  <jms:outbound-channel-adapter
      channel="dtsJobEvents"
      connection-factory="jmsConnectionFactory"
      destination="jmsJobEventQueue"
      />

  <beans:bean id="dtsJobRequestHandler"
              class="org.springframework.batch.integration.launch.JobLaunchingMessageHandler">
    <beans:constructor-arg index="0" ref="dtsJobLauncher"/>
  </beans:bean>

  <service-activator input-channel="dtsJobRequests"
                     output-channel="dtsJobExecutions"
                     ref="dtsJobRequestHandler"/>

  <logging-channel-adapter channel="dtsJobExecutions"/>

  <beans:bean id="dtsMarshaller"
              class="org.springframework.oxm.xmlbeans.XmlBeansMarshaller">
    <beans:property name="validating" value="true"/>
    <beans:property name="xmlOptions">
      <beans:bean class="org.apache.xmlbeans.XmlOptionsBean">
        <beans:property name="savePrettyPrint" value="true"/>
        <beans:property name="saveNamespacesFirst" value="true"/>
      </beans:bean>
    </beans:property>
  </beans:bean>

  <beans:bean id="dtsMessagePayloadTransformer"
              class="org.dataminx.dts.wn.jms.DtsMessagePayloadTransformer">
    <beans:constructor-arg index="0" ref="dtsMarshaller"/>
  </beans:bean>

</beans:beans>
